<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tracker 24/7</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        .hidden { display: none !important; }
        
        /* Màn hình Login */
        #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .auth-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { display: block; margin: 10px 0; padding: 10px; width: 200px; }
        
        /* Màn hình Chính */
        #main-screen { height: 100vh; display: flex; flex-direction: column; }
        .table-section { flex: 2; overflow-y: auto; background: white; padding: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f8f8f8; position: sticky; top: 0; }

        .control-section { flex: 1; border-top: 2px solid #ddd; background: #fff; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* Process Line */
        .progress-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .progress-bar-bg { flex: 1; background: #eee; height: 25px; border-radius: 12px; overflow: hidden; position: relative; }
        .progress-fill { background: #28a745; height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 25px; font-size: 12px; font-weight: bold; }
        
        /* Buttons */
        .action-row { display: flex; justify-content: space-between; align-items: center; }
        .btn-finish { background: #ff9800; color: white; border: none; padding: 15px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .nav-group { display: flex; gap: 10px; }
        .btn-nav { padding: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Đăng nhập / Đăng ký</h2>
            <input type="text" id="username" placeholder="Tên tài khoản">
            <input type="password" id="password" placeholder="Mật khẩu">
            <button onclick="handleAuth()">Tiếp tục</button>
        </div>
    </div>

    <div id="main-screen" class="hidden">
        <div class="table-section">
            <h3 id="table-title">Tháng 02/2026</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Giờ về</th>
                    </tr>
                </thead>
                <tbody id="ot-body"></tbody>
            </table>
        </div>

        <div class="control-section">
            <div class="progress-container">
                <div class="progress-bar-bg">
                    <div id="progress-fill" class="progress-fill"></div>
                    <span id="progress-text" class="progress-text">0/40h</span>
                </div>
                <div id="money-label" style="font-weight: bold; color: #007bff; min-width: 80px;">0đ</div>
            </div>

            <div class="action-row">
                <button class="btn-finish" onclick="saveOT()">KẾT THÚC GIỜ LÀM</button>
                <div class="nav-group">
                    <button class="btn-nav" onclick="changeMonth(-1)">◀</button>
                    <button class="btn-nav" onclick="changeMonth(1)">▶</button>
                    <button class="btn-nav" onclick="openSettings()">⚙️</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH FIREBASE (Bạn cần thay thông tin này từ Console Firebase của bạn) ---
        const firebaseConfig = {
            databaseURL: "https://thechamcong-dcd6e-default-rtdb.asia-southeast1.firebasedatabase.app/",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let viewDate = new Date(); // Ngày đang xem trên table

        // 1. XỬ LÝ ĐĂNG NHẬP / ĐĂNG KÝ
        async function handleAuth() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if(!user || !pass) return alert("Nhập đủ thông tin!");

            const snapshot = await db.ref('users/' + user).once('value');
            const userData = snapshot.val();

            if (userData) {
                if (userData.password === pass) {
                    loginSuccess(user, userData);
                } else {
                    alert("Sai mật khẩu!");
                }
            } else {
                if (confirm("Tài khoản chưa tồn tại. Bạn có muốn tạo mới?")) {
                    const newUser = { password: pass, ot_goal: 40, rate: 50000 };
                    await db.ref('users/' + user).set(newUser);
                    loginSuccess(user, newUser);
                }
            }
        }

        function loginSuccess(user, data) {
            currentUser = { id: user, ...data };
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            renderTable();
        }

        // 2. LOGIC TÍNH CHU KỲ (21 THÁNG TRƯỚC - 20 THÁNG NÀY)
        function renderTable() {
            const month = viewDate.getMonth() + 1;
            const year = viewDate.getFullYear();
            document.getElementById('table-title').innerText = `Chu kỳ: 21/${month-1} - 20/${month}/${year}`;
            
            // Lấy dữ liệu từ Firebase
            db.ref('logs/' + currentUser.id).on('value', snapshot => {
                const logs = snapshot.val() || {};
                const tbody = document.getElementById('ot-body');
                tbody.innerHTML = '';
                
                let totalOTMinutes = 0;
                
                // Logic hiển thị các ngày trong chu kỳ
                // (Phần này cần loop từ ngày 21 tháng trước đến 20 tháng này)
                // Tạm thời hiển thị các dữ liệu đã có trong DB
                Object.values(logs).forEach(log => {
                    const row = `<tr><td>${log.date}</td><td>${log.time}</td></tr>`;
                    tbody.innerHTML += row;
                    // Giả định mỗi lần bấm là 2h OT để tính process bar
                    totalOTMinutes += 120; 
                });

                updateProgress(totalOTMinutes / 60);
            });
        }

        // 3. LƯU THỜI GIAN
        function saveOT() {
            if(!confirm("Lưu thời gian kết thúc hôm nay?")) return;
            const now = new Date();
            const dateStr = now.toLocaleDateString('vi-VN');
            const timeStr = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});

            db.ref('logs/' + currentUser.id).push({
                date: dateStr,
                time: timeStr,
                timestamp: now.getTime()
            });
        }

        function updateProgress(hours) {
            const goal = currentUser.ot_goal;
            const percent = Math.min((hours / goal) * 100, 100);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').innerText = `${hours.toFixed(1)}/${goal}h`;
            document.getElementById('money-label').innerText = (hours * currentUser.rate).toLocaleString() + 'đ';
        }

        function changeMonth(step) {
            viewDate.setMonth(viewDate.getMonth() + step);
            renderTable();
        }
    </script>
</body>
</html>