<!DOCTYPE html>
<html lang="vi";
      -webkit-text-size-adjust: 100%;>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The cham cong</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            font-size: 16px;
            height: 100vh;
            overflow: hidden;
        }
        button {
            border: none;
            height: 40px;
            width: 100px;
            cursor: pointer;
            border-radius: 25px;
            margin: 5px 5px 15px 5px;
            font-size: 16px;
        }
        .hidden {
            display: none !important;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Login */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
            #login-screen h4 {
                font-size: 16px;
                text-align: center;
                margin-bottom: 25px;
            }
        .auth-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input {
            display: block;
            margin: 10px 0;
            padding: 10px;
            width: 200px;
            font-size: 16px;
        }
        .btn-login {
            margin-top: 10px;
            width: 224px;
            height: 40px;
            border-radius: 7px;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        /* mainbody */
        .header {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: left;
            padding-left:20px;
            font-size: 18px;
            font-weight: bold;
            background: #f2f2f2;
        }
        .main {
            flex: 7;
            position: relative;
            overflow: hidden;
            background: #ffffff;
        }
        .card-wrapper {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.4s ease;
        }
        .card {
            width: 50%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        .table-area table, th, td{
            border: 1px solid #ccc;
        }
        .table-area th, td {
            padding: 8px;
            text-align: center;
            font-weight: normal;
            font-size: 16px;
        }
        .table-area th {
            background: #f2f2f2;
        }
        /* Process Line */
        .progress-area {
            display: flex;
            width: 100%;
            flex-direction: row;
            align-items: center;
            padding: 15px;
            gap: 10px;
        }
        .progress-container {
            flex: 4;
        }
        .progress-bar-bg {
            width: 100%;
            background: #eee;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            background: #28a745;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            font-size: 16px;
            font-weight: normal;
            color: white;
        }
        #money-label {
            flex: 1;
            font-weight: normal;
            color: #007bff;
            font-size: 16px;
            text-align: center;
            align-items: center;
            padding-right: 16px;
        }


        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .overlay button {
            font-size: 16px;
            
            padding: 8px 14px;
            width: 75px;
        }
        .modal {
            background: white;
            padding: 10px;
            border-radius: 25px;
            width: 280px;
            text-align: center;
        }
            .modal h3 {
                text-align: center;
                font-size: 16px;
                font-weight: bold;
            }
            .modal .btn-section {
                padding-top: 10px;
            }

        #mainCard {
            display: flex;
            flex-direction: column;
        }
        .maincard-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .table-area {
            flex: 9;
            min-height: 0;
            overflow-y: auto;
            display: flex;
        }
        .table-area table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .input-group {
            margin-bottom: 10px;
            text-align: left;
            padding-left: 25px;
        }
        .btn-Logout {
            background: #dc3545;
            color: white;
        }
        .btn-Save {
            background: #28a745;
            color: white;
        }
        .footer {
            flex: 2;
            display: flex;
            padding: 15px;
            background: #f2f2f2;
        }
            .footer button {
                border: none;
                font-size: 16px;
                cursor: pointer;
                border-radius: 25px;
                margin: 5px;
            }
        .small-btn {
            width: 12%;
            background: #e0e0e0;
        }
        .normal-btn {
            width: 20%;
            background: #c4dc48;
        }
        .big-btn {
            width: 32%;
            background: #ff6666;
            color: white;
            font-weight: normal;
        }
    </style>
</head>

<body>
    <div id="login-screen">
        <div class="login-card">
            <h4>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h4>
            <input type="email" id="username" placeholder="Email">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-login" onclick="handleAuth()">Ti·∫øp t·ª•c</button>
        </div>
    </div>

    <div id="main-screen" class="hidden">
        <div class="container">
            <!-- HEADER -->
            <div class="header">
                <div id="welcome-text"> Welcome abc</div>
            </div>

            <!-- MAIN -->
            <div class="main">
                <div class="card-wrapper" id="cardWrapper">
                    <!-- MAIN CARD -->
                    <div class="card" id="mainCard">
                        <h4 id="table-title"></h4>
                        <div class="mainCard-content">
                            <div class="table-area">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ng√†y th√°ng</th>
                                            <th>Gi·ªù</th>
                                            <th>Ng√†y th√°ng</th>
                                            <th>Gi·ªù</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ot-body"></tbody>
                                </table>
                            </div>
                            <div class="progress-area">
                                <div class="progress-container">
                                    <div class="progress-bar-bg">
                                        <span id="progress-text" class="progress-text">0/40h</span>
                                        <div id="progress-fill" class="progress-fill"></div>
                                    </div>
                                </div>
                                <div id="money-label">0ƒë</div>
                            </div>
                        </div>
                    </div>
                    <!-- SETTING CARD -->
                    <div class="card" id="settingCard">
                        <!--nothing-->
                        <h3>dang xay dung</h3>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="footer">
                <button class="small-btn" onclick="openSettings()">‚öôÔ∏è</button>
                <button class="small-btn" onclick="openAddManual()">Ôºã</button>
                <button class="small-btn" onclick="changeMonth(-1)">‚óÄ</button>
                <button class="small-btn" onclick="changeMonth(1)">‚ñ∂</button>
                <button class="big-btn" onclick="openConfirm()">K·∫æT TH√öC</button>
                <button class="normal-btn" onclick="showCalendar()">üìÖ</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="overlay" id="setting" onclick="closeSetting(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>C√†i ƒë·∫∑t</h3>

            <div class="input-group">
                <label>S·ªë gi·ªù OT m·ª•c ti√™u (h):</label><br>
                <input type="number" id="set-goal" placeholder="V√≠ d·ª•: 40">
            </div>

            <div class="input-group">
                <label>S·ªë ti·ªÅn/gi·ªù (JPY):</label><br>
                <input type="number" id="set-rate" placeholder="V√≠ d·ª•: 1500">
            </div>

            <div class="input-group">
                <label>T√™n hi·ªÉn th·ªã:</label><br>
                <input type="text" id="set-name" placeholder="T√™n c·ªßa b·∫°n">
            </div>
            <div class="btn-section">
                <button class="btn-Logout" onclick="logout()">Logout</button>
                <button class="btn-Save" onclick="saveSettings()">L∆∞u</button>
                <button onclick="closeSetting()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

        <div class="overlay" id="overlay" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
                <p>C√≥ mu·ªën k·∫øt th√∫c ngay ?</p>
                <button onclick="confirmEnd()">Yes</button>
                <button onclick="closeModal()">No</button>
            </div>
        </div>

        <div class="overlay" id="add-edit" onclick="closeManual(event)">
            <div class="modal" onclick="event.stopPropagation()">
                <h3>Th√™m / S·ª≠a ng√†y l√†m</h3>
                <div class="input-group">
                    <label>Ng√†y:</label><br>
                    <input type="date" id="manual-date">
                </div>
                <div class="input-group">
                    <label>Gi·ªù v·ªÅ:</label><br>
                    <input type="time" id="manual-time">
                </div>
                <div class="btn-section">
                    <button class="btn-Save" onclick="saveManual()">L∆∞u</button>
                    <button onclick="closeManual()">ƒê√≥ng</button>
                </div>

            </div>
        </div>

        <script>
            // --- FIREBASE SETTING
            const firebaseConfig = {
                apiKey: "AIzaSyCxGeOoiqcG2R1gmA5iWK9XjpcF3K0jGOs",
                authDomain: "thechamcong-dcd6e.firebaseapp.com",
                databaseURL: "https://thechamcong-dcd6e-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "thechamcong-dcd6e",
                storageBucket: "thechamcong-dcd6e.firebasestorage.app",
                messagingSenderId: "141017912990",
                appId: "1:141017912990:web:79ed5594b2f7ed3e624d8f"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();

            let logsRef = null;
            let allLogs = {};

            let currentUser = null;
            let viewDate = new Date(); // Ng√†y ƒëang xem tr√™n table

            // login/register
            async function handleAuth() {
                const email = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    alert("Nh·∫≠p ƒë·ªß email v√† m·∫≠t kh·∫©u!");
                    return;
                }

                try {
                    // Th·ª≠ ƒëƒÉng nh·∫≠p tr∆∞·ªõc
                    const userCred = await auth.signInWithEmailAndPassword(email, password);
                    onAuthSuccess(userCred.user);

                } catch (err) {

                    console.log(err.code);
                    console.log(err.message);

                    if (
                        err.code === 'auth/user-not-found' ||
                        err.code === 'auth/invalid-login-credentials'
                    ) {
                        if (confirm("T√†i kho·∫£n ch∆∞a t·ªìn t·∫°i ho·∫∑c sai m·∫≠t kh·∫©u.\nB·∫°n c√≥ mu·ªën t·∫°o m·ªõi kh√¥ng?")) {

                            const userCred = await auth.createUserWithEmailAndPassword(email, password);
                            const randomName = generateRandomName();

                            await db.ref('users/' + userCred.user.uid).set({
                                display_name: randomName,
                                ot_goal: 40,
                                rate: 50000
                            });
                            onAuthSuccess(userCred.user);
                        }
                    }
                    else if (err.code === 'auth/wrong-password') {
                        alert("Sai m·∫≠t kh·∫©u!");
                    }
                    else {
                        alert(err.message);
                    }
                }
            }
            async function onAuthSuccess(firebaseUser) {
                const uid = firebaseUser.uid;

                const snapshot = await db.ref('users/' + uid).once('value');
                const data = snapshot.val() || {
                    display_name: generateRandomName(),
                    ot_goal: 40,
                    rate: 50000
                };

                currentUser = {
                    id: uid,
                    name: data.display_name,
                    ot_goal: data.ot_goal,
                    rate: data.rate
                };
                document.getElementById('welcome-text').innerText = "Xin ch√†o " + currentUser.name;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');

                if (logsRef) logsRef.off();

                logsRef = db.ref('logs/' + currentUser.id);
                logsRef.on('value', snapshot => {
                    allLogs = snapshot.val() || {};
                    renderTable();
                });
            }

            // LOGIC
            async function saveWork() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');

                const dateId = `${y}-${m}-${d}`;
                const timeStr = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                await db.ref('logs/' + currentUser.id + '/' + dateId).set({
                    time: timeStr,
                    timestamp: now.getTime()
                });
            }

            function updateProgress(totalHours) {
                if (!currentUser) return;

                const goal = parseFloat(currentUser.ot_goal) || 40;
                const percent = Math.min((totalHours / goal) * 100, 100);

                const fill = document.getElementById('progress-fill');
                const text = document.getElementById('progress-text');
                const money = document.getElementById('money-label');

                if (fill) fill.style.width = percent + '%';
                if (text) text.innerText = totalHours.toFixed(1) + "h / " + goal + "h";
                if (money) money.innerText =
                    (totalHours * currentUser.rate).toLocaleString() + "¬•";
            }


            function showMain() {
                document.getElementById("cardWrapper").style.transform = "translateX(0)";
                currentIndex = 0;
            }
            function showCalendar() { //slide qua page khac
                document.getElementById("cardWrapper").style.transform = "translateX(-50%)";
                currentIndex = 1;
            }
            function openConfirm() {
                document.getElementById("overlay").style.display = "flex";
            }
            function confirmEnd() {
                closeModal();
                saveWork();

                renderTable();
                showMain();
            }
            function changeMonth(step) {
                showMain();
                viewDate.setMonth(viewDate.getMonth() + step);
                renderTable();
            }
            function openSettings() {
                document.getElementById("setting").style.display = "flex";
                document.getElementById('set-name').value = currentUser.name;
                document.getElementById('set-goal').value = currentUser.ot_goal;
                document.getElementById('set-rate').value = currentUser.rate;
            }
            function closeSetting() {
                document.getElementById("setting").style.display = "none";
            }
            async function saveSettings() {
                const newName = document.getElementById('set-name').value;
                const newGoal = document.getElementById('set-goal').value;
                const newRate = document.getElementById('set-rate').value;

                await db.ref('users/' + currentUser.id).update({
                    display_name: newName,
                    ot_goal: parseFloat(newGoal),
                    rate: parseInt(newRate)
                });

                currentUser.name = newName;
                currentUser.rate = parseInt(newRate);
                currentUser.ot_goal = parseFloat(newGoal);

                document.getElementById('welcome-text').innerText =
                    "Xin ch√†o " + currentUser.name;
                renderTable();

                updateMonthLabel();
                showMain();
            }
            function openAddManual(dateId = null, time = null) {
                document.getElementById("add-edit").style.display = "flex";

                if (dateId) {
                    document.getElementById('manual-date').value = dateId;
                    document.getElementById('manual-time').value = time || '';
                } else {
                    document.getElementById('manual-date').value = '';
                    document.getElementById('manual-time').value = '';
                }
            }
            function closeManual() {
                document.getElementById("add-edit").style.display = "none";
            }
            async function saveManual() {
                const date = document.getElementById('manual-date').value;
                const time = document.getElementById('manual-time').value;

                if (!date || !time) {
                    alert("Nh·∫≠p ƒë·ªß ng√†y v√† gi·ªù");
                    return;
                }

                const dateId = date; // yyyy-mm-dd

                await db.ref('logs/' + currentUser.id + '/' + dateId).set({
                    time: time,
                    timestamp: new Date(date + 'T' + time).getTime()
                });
                closeManual();
                renderTable();
                showMain();
            }
            function closeModal() {
                document.getElementById("overlay").style.display = "none";
            }

            function renderTable() {
                const month = viewDate.getMonth();
                const year = viewDate.getFullYear();

                const startDate = new Date(year, month - 1, 21);
                const endDate = new Date(year, month, 20);

                document.getElementById('table-title').innerText = `Th√°ng ${month + 1}/${year}`;

                const logs = allLogs || {};
                const tbody = document.getElementById('ot-body');
                tbody.innerHTML = '';

                let totalHours = 0;
                const daysWithLogs = [];

                // L·∫•y c√°c ng√†y c√≥ d·ªØ li·ªáu
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');

                    const dateId = `${y}-${m}-${day}`;

                    if (logs[dateId]) {
                        const time = logs[dateId].time;

                        daysWithLogs.push({
                            date: `${day}/${m}/${y}`,
                            dateId: dateId,
                            time: time
                        });

                        totalHours += calculateOT(time);
                    }
                }

                // Chia l√†m 2 n·ª≠a
                const half = Math.ceil(daysWithLogs.length / 2);
                const leftSide = daysWithLogs.slice(0, half);
                const rightSide = daysWithLogs.slice(half);

                const maxRows = Math.max(leftSide.length, rightSide.length);

                for (let i = 0; i < maxRows; i++) {
                    const left = leftSide[i];
                    const right = rightSide[i];

                    const row = `
                                            <tr>
                                                <td onclick="${left ? `openAddManual('${left.dateId}','${left.time}')` : ''}">
                                                    ${left ? left.date : ''}
                                                </td>
                                                <td onclick="${left ? `openAddManual('${left.dateId}','${left.time}')` : ''}">
                                                    ${left ? left.time : ''}
                                                </td>

                                                <td onclick="${right ? `openAddManual('${right.dateId}','${right.time}')` : ''}">
                                                    ${right ? right.date : ''}
                                                </td>
                                                <td onclick="${right ? `openAddManual('${right.dateId}','${right.time}')` : ''}">
                                                    ${right ? right.time : ''}
                                                </td>

                                            </tr>
                                        `;

                    tbody.innerHTML += row;
                }

                updateProgress(totalHours);
            }

            function calculateMonthlyOT(data) {
                let total = 0;

                Object.values(data || {}).forEach(day => {
                    total += day.otHours || 0;
                });

                return total;
            }
            function calculateOT(timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                let end = h * 60 + m;

                const start = 17 * 60 + 40;
                const overnightLimit = 8 * 60 + 29;

                // N·∫øu v·ªÅ sau 0h ‚Üí c·ªông 24h
                if (end <= overnightLimit) {
                    end += 24 * 60;
                }

                if (end <= start) return 0;

                const diff = end - start;
                const rounded = Math.floor(diff / 15) * 15;

                return rounded / 60;
            }



            function logout() {
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) return;

                auth.signOut().then(() => {
                    // reset d·ªØ li·ªáu local
                    currentUser = null;
                    allLogs = {};

                    if (logsRef) logsRef.off();

                    // quay l·∫°i m√†n h√¨nh login
                    closeSetting()
                    document.getElementById('main-screen').classList.add('hidden');
                    document.getElementById('settings-screen').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                });
            }
            function generateRandomName() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 5; i++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return 'USER-' + code;
            }

            window.onload = function () {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        onAuthSuccess(user);
                    }
                });
            };
        </script>
</body>

</html>
